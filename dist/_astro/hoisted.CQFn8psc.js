import{g as C}from"./supabase-client.DOekNLRN.js";import"./index.9QnQ_JI4.js";import"./_commonjsHelpers.C4iS2aBk.js";console.log("üîÑ [Callback] Script iniciado");const a=setTimeout(()=>{console.error("‚è±Ô∏è [Callback] Timeout: El proceso tard√≥ demasiado, redirigiendo..."),window.location.href=`/?error=${encodeURIComponent("Timeout: El proceso de autenticaci√≥n tard√≥ demasiado. Por favor, intenta nuevamente.")}&_t=${Date.now()}`},1e4);try{const o=C();console.log("‚úÖ [Callback] Cliente Supabase obtenido (mismo que inici√≥ el flujo)");const l=new URLSearchParams(window.location.search),t=l.get("code"),s=l.get("error"),r=l.get("redirect")||"/";console.log("üîç [Callback] Par√°metros detectados:",{hasCode:!!t,hasError:!!s,redirectTo:r}),(async()=>{try{if(s){clearTimeout(a),console.error("‚ùå [Callback] Error en OAuth:",s),window.location.href=`/?error=${encodeURIComponent(s)}&_t=${Date.now()}`;return}if(t){console.log("üîÑ [Callback] C√≥digo OAuth detectado:",t.substring(0,20)+"..."),console.log("‚è≥ [Callback] Esperando procesamiento autom√°tico de Supabase..."),await new Promise(e=>setTimeout(e,500));let{data:n,error:f}=await o.auth.getSession();if(n?.session){console.log("‚úÖ [Callback] Supabase proces√≥ el c√≥digo autom√°ticamente:",n.session.user.email),clearTimeout(a),await new Promise(e=>setTimeout(e,200)),window.location.href=`${r}?success=login&_t=${Date.now()}`;return}console.log("üîÑ [Callback] No se proces√≥ autom√°ticamente, intentando intercambio manual...");const b=window.localStorage,u=Object.keys(b),m=u.filter(e=>e.includes("supabase")||e.includes("sb-")||e.includes("auth")||e.includes("verifier")||e.includes("pkce"));console.log("üîç [Callback] Debug localStorage:",{totalKeys:u.length,supabaseKeys:m.length,allSupabaseKeys:m});let i,g=null;try{const e=o.auth.exchangeCodeForSession(t),d=new Promise((E,p)=>setTimeout(()=>p(new Error("Exchange timeout after 8 seconds")),8e3));i=await Promise.race([e,d])}catch(e){console.error("‚ùå [Callback] Timeout o error en intercambio:",e),g=e,i=null}const w=i?.data||null,h=i?.error||null,c=g||h;if(clearTimeout(a),c){const{data:e}=await o.auth.getSession();if(e?.session){console.log("‚úÖ [Callback] Sesi√≥n encontrada despu√©s del error (delay):",e.session.user.email),window.location.href=`${r}?success=login&_t=${Date.now()}`;return}console.error("‚ùå [Callback] Error intercambiando c√≥digo:",c);const d=c.message||c.toString()||"Error intercambiando c√≥digo";window.location.href=`/?error=${encodeURIComponent(d)}&_t=${Date.now()}`;return}w?.session?(console.log("‚úÖ [Callback] Sesi√≥n creada exitosamente (intercambio manual):",w.session.user.email),await new Promise(e=>setTimeout(e,200)),window.location.href=`${r}?success=login&_t=${Date.now()}`):(console.error("‚ùå [Callback] No se obtuvo sesi√≥n despu√©s del intercambio"),window.location.href=`/?error=${encodeURIComponent("No se pudo crear la sesi√≥n")}&_t=${Date.now()}`)}else clearTimeout(a),console.log("üîÑ [Callback] No hay c√≥digo, redirigiendo a:",r),window.location.href=`${r}?success=login&_t=${Date.now()}`}catch(n){clearTimeout(a),console.error("‚ùå [Callback] Error inesperado:",n),window.location.href=`/?error=${encodeURIComponent("Error procesando la autenticaci√≥n: "+(n.message||"Error desconocido"))}&_t=${Date.now()}`}})()}catch(o){clearTimeout(a),console.error("‚ùå [Callback] Error inicializando script:",o),window.location.href=`/?error=${encodeURIComponent("Error inicializando autenticaci√≥n: "+(o.message||"Error desconocido"))}&_t=${Date.now()}`}
