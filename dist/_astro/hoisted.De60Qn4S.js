import{g as x}from"./supabase-client.DOekNLRN.js";import{h as y}from"./session-sync.BLQ7z1dq.js";import"./index.9QnQ_JI4.js";import"./_commonjsHelpers.C4iS2aBk.js";const u=x();async function w(e=!1){console.log("üé® [Index] updateUserUI llamado",{forceRefresh:e});try{e&&(console.log("‚è≥ [Index] Esperando sincronizaci√≥n de sesi√≥n..."),await new Promise(s=>setTimeout(s,500)));let o=null,t=null;console.log("üîç [Index] Obteniendo sesi√≥n...");for(let s=0;s<3;s++){console.log(`   Intento ${s+1}/3...`);const h=await u.auth.getSession();if(o=h.data?.session||null,t=h.error,o||!t){console.log(`‚úÖ [Index] Sesi√≥n obtenida en intento ${s+1}`,{hasSession:!!o,userEmail:o?.user?.email||"N/A"});break}s<2&&await new Promise(v=>setTimeout(v,300))}o||(console.log("üîÑ [Index] Intentando hidratar sesi√≥n desde el servidor..."),o=await y(u)),t&&!o?console.error("‚ùå [Index] Error getting session despu√©s de reintentos:",t):o||console.log("‚ÑπÔ∏è [Index] No hay sesi√≥n activa");const r=document.getElementById("login-btn"),l=document.getElementById("user-info"),n=document.getElementById("user-name"),a=document.getElementById("user-avatar");if(o?.user){r&&r.classList.add("hidden"),l&&l.classList.remove("hidden");const s=o.user.user_metadata?.full_name||o.user.user_metadata?.name||o.user.email?.split("@")[0]||"Usuario";n&&(n.textContent=s);const h=o.user.user_metadata?.avatar_url||o.user.user_metadata?.picture||`https://ui-avatars.com/api/?name=${encodeURIComponent(s)}&background=EB9561&color=fff&size=128`;a&&(a.src=h,a.alt=s)}else r&&r.classList.remove("hidden"),l&&l.classList.add("hidden")}catch(o){console.error("Error updating UI:",o)}}window.handleLogout=async function(){const{error:e}=await u.auth.signOut();try{await fetch("/api/auth/session",{method:"DELETE",credentials:"same-origin"})}catch(o){console.error("Error al limpiar la sesi√≥n del servidor:",o)}e?(console.error("Error al cerrar sesi√≥n:",e),alert("Error al cerrar sesi√≥n")):(await w(),window.location.href="/")};window.updateUserUI=w;window.hydrateSupabaseSession=()=>y(u);let c=!1;u.auth.onAuthStateChange((e,o)=>{c||(c=!0,w().finally(()=>{setTimeout(()=>{c=!1},500)}))});const A=new URLSearchParams(window.location.search),b=A.get("success"),S=A.get("error"),U=A.get("code"),C=A.get("auth_callback");U&&C?(console.log("üîÑ [Index] C√≥digo OAuth detectado en URL"),(async()=>{try{await new Promise(t=>setTimeout(t,100));let{data:e,error:o}=await u.auth.getSession();if(e?.session)console.log("‚úÖ [Index] Supabase proces√≥ el c√≥digo autom√°ticamente:",e.session.user.email);else{console.log("üîÑ [Index] Supabase no proces√≥ autom√°ticamente, intentando intercambio manual...");const{data:t,error:r}=await u.auth.exchangeCodeForSession(U);if(r){console.error("‚ùå [Index] Error intercambiando c√≥digo:",r),r.message.includes("code verifier")?(console.error("‚ùå [Index] Error: code_verifier no encontrado. Esto puede ocurrir si:"),console.error("   1. El storage fue limpiado durante el redirect"),console.error("   2. Hay un problema con el dominio/subdominio"),console.error("   3. El c√≥digo expir√≥ (son v√°lidos por ~10 minutos)"),alert("Error en la autenticaci√≥n: El c√≥digo de verificaci√≥n no se encuentra. Por favor, intenta iniciar sesi√≥n nuevamente.")):alert("Error en la autenticaci√≥n: "+r.message),window.history.replaceState({},document.title,window.location.pathname);return}t.session&&(console.log("‚úÖ [Index] Sesi√≥n creada desde c√≥digo OAuth:",t.session.user.email),e=t)}e?.session&&(window.history.replaceState({},document.title,window.location.pathname),c||(c=!0,await w(!0),setTimeout(()=>{c=!1},500)))}catch(e){console.error("‚ùå [Index] Error inesperado intercambiando c√≥digo:",e),alert("Error procesando la autenticaci√≥n"),window.history.replaceState({},document.title,window.location.pathname)}})()):((b||S)&&window.history.replaceState({},document.title,window.location.pathname),b==="login"?(async()=>(console.log("üîÑ [Index] OAuth completado, sincronizando sesi√≥n cliente/servidor..."),await y(u),setTimeout(()=>{c||(c=!0,w(!0).finally(()=>{setTimeout(()=>{c=!1},500)}))},300)))():w(),S&&setTimeout(()=>{alert("Error en la autenticaci√≥n: "+decodeURIComponent(S))},100));const d=x();window.hydrateSupabaseSession||(window.hydrateSupabaseSession=()=>y(d));let i="login",M=null;const m=document.getElementById("auth-modal"),E=document.getElementById("auth-form"),p=document.getElementById("auth-message"),_=document.getElementById("close-auth-modal"),T=document.getElementById("google-auth-btn"),B=document.getElementById("login-link"),D=document.getElementById("register-link"),P=document.getElementById("forgot-password-link"),O=document.getElementById("back-to-login-link");async function N(){console.log("üîê [AuthModal] Inicializando autenticaci√≥n...");try{await y(d);const{data:{session:e},error:o}=await d.auth.getSession();o?console.error("‚ùå [AuthModal] Error al obtener sesi√≥n inicial:",o):e?(console.log("‚úÖ [AuthModal] Sesi√≥n existente encontrada:",e.user.email),M=e.user,void 0):console.log("‚ÑπÔ∏è [AuthModal] No hay sesi√≥n activa")}catch(e){console.error("‚ùå [AuthModal] Error en initAuth:",e)}d.auth.onAuthStateChange((e,o)=>{console.log(`üîÑ [AuthModal] Auth state changed: ${e}`,{event:e,hasSession:!!o,userEmail:o?.user?.email||"N/A",userId:o?.user?.id||"N/A"}),M=o?.user||null,e==="SIGNED_IN"?(console.log("‚úÖ [AuthModal] Usuario inici√≥ sesi√≥n, actualizando UI"),I(),window.updateUserUI?(console.log("üì° [AuthModal] Llamando updateUserUI..."),window.updateUserUI(!0)):console.warn("‚ö†Ô∏è [AuthModal] updateUserUI no est√° disponible en window")):e==="SIGNED_OUT"?(console.log("üëã [AuthModal] Usuario cerr√≥ sesi√≥n"),window.updateUserUI&&window.updateUserUI(!0)):e==="TOKEN_REFRESHED"?console.log("üîÑ [AuthModal] Token refrescado"):e==="USER_UPDATED"&&console.log("üë§ [AuthModal] Usuario actualizado")}),console.log("‚úÖ [AuthModal] Autenticaci√≥n inicializada, listener configurado")}function g(e="login"){i=e,z(),m&&(m.classList.remove("hidden"),m.classList.add("flex"))}function I(){m&&(m.classList.add("hidden"),m.classList.remove("flex")),E&&E.reset(),L()}function z(){const e=document.querySelector("#auth-modal h2"),o=document.querySelector("#auth-modal p"),t=document.querySelector('#auth-form button[type="submit"]'),r=document.getElementById("password"),l=document.getElementById("name");e&&(e.textContent=i==="login"?"Iniciar Sesi√≥n":i==="register"?"Crear Cuenta":"Recuperar Contrase√±a"),o&&(o.textContent=i==="login"?"Accede a tu cuenta para gestionar propiedades":i==="register"?"Crea tu cuenta para empezar":"Ingresa tu email para recuperar tu contrase√±a"),t&&(t.textContent=i==="login"?"Iniciar Sesi√≥n":i==="register"?"Crear Cuenta":"Enviar Email"),r&&r.parentElement&&(r.parentElement.style.display=i==="forgot-password"?"none":"block"),l&&l.parentElement&&(l.parentElement.style.display=i==="register"?"block":"none")}function f(e,o="error"){p&&(p.textContent=e,p.className=`mt-4 p-3 rounded-lg ${o==="error"?"bg-red-50 text-red-700 border border-red-200":"bg-green-50 text-green-700 border border-green-200"}`,p.classList.remove("hidden"))}function L(){p&&p.classList.add("hidden")}async function k(e){if(!(!e?.access_token||!e?.refresh_token))try{const o=await fetch("/api/auth/session",{method:"POST",headers:{"content-type":"application/json"},credentials:"same-origin",body:JSON.stringify({session:{access_token:e.access_token,refresh_token:e.refresh_token}})});o.ok?console.log("‚úÖ [AuthModal] Sesi√≥n sincronizada con el servidor"):console.error("‚ö†Ô∏è [AuthModal] No se pudo sincronizar la sesi√≥n con el servidor",await o.text())}catch(o){console.error("‚ö†Ô∏è [AuthModal] Error al sincronizar sesi√≥n con el servidor:",o)}}async function R(e){if(e.preventDefault(),L(),!E)return;const o=new FormData(E),t=o.get("email"),r=o.get("password"),l=o.get("name");if(!t||!t.includes("@")){f("Por favor ingresa un email v√°lido");return}if(i!=="forgot-password"&&!r){f("Por favor ingresa tu contrase√±a");return}try{if(i==="login"){console.log("üîê [AuthModal] Iniciando login para:",t);const{data:n,error:a}=await d.auth.signInWithPassword({email:t,password:r});if(a)throw console.error("‚ùå [AuthModal] Error en login:",{message:a.message,status:a.status,name:a.name}),a;if(n.session){await k(n.session),console.log("‚úÖ [AuthModal] Login exitoso, sesi√≥n creada:",{email:n.session.user.email,userId:n.session.user.id,expiresAt:new Date(n.session.expires_at*1e3).toISOString()}),console.log("‚è≥ [AuthModal] Esperando persistencia de sesi√≥n..."),await new Promise(v=>setTimeout(v,200)),console.log("üîç [AuthModal] Verificando sesi√≥n persistida...");const{data:{session:s},error:h}=await d.auth.getSession();if(h&&console.error("‚ö†Ô∏è [AuthModal] Error al verificar sesi√≥n despu√©s del login:",h),s){if(await k(s),console.log("‚úÖ [AuthModal] Sesi√≥n verificada y persistida correctamente:",{email:s.user.email,storageKey:"sb-auth-token",localStorage:typeof window<"u"&&!!window.localStorage}),window.updateUserUI)console.log("üì° [AuthModal] Disparando updateUserUI..."),window.updateUserUI(!0);else{console.warn("‚ö†Ô∏è [AuthModal] updateUserUI no disponible, recargando p√°gina..."),window.location.reload();return}setTimeout(()=>{console.log("‚úÖ [AuthModal] Cerrando modal de autenticaci√≥n"),I()},500)}else console.warn("‚ö†Ô∏è [AuthModal] La sesi√≥n no se persisti√≥ correctamente, recargando p√°gina..."),window.location.href=window.location.pathname+"?login=success&_t="+Date.now()}else throw console.error("‚ùå [AuthModal] Login exitoso pero no hay sesi√≥n en data.session"),new Error("No se pudo iniciar sesi√≥n. Por favor intenta de nuevo.")}else if(i==="register"){const{data:n,error:a}=await d.auth.signUp({email:t,password:r,options:{data:{full_name:l}}});if(a)throw console.error("Error en registro:",a),a;n.user&&(f("¬°Cuenta creada! Revisa tu email para confirmar tu cuenta.","success"),setTimeout(()=>{g("login"),f("Ahora puedes iniciar sesi√≥n con tu nueva cuenta","success")},3e3))}else if(i==="forgot-password"){const{error:n}=await d.auth.resetPasswordForEmail(t,{redirectTo:`${window.location.origin}/auth/callback?mode=recovery`});if(n)throw console.error("Error en recuperaci√≥n de contrase√±a:",n),n;f("¬°Email enviado! Revisa tu bandeja de entrada.","success")}}catch(n){console.error("Error completo en autenticaci√≥n:",n);const a=n?.message||n?.error_description||"Error en la autenticaci√≥n";f(a)}}async function F(){try{const e=`${window.location.protocol}//${window.location.host}/auth/callback`;console.log("üîê Iniciando OAuth con redirectTo:",e);const{data:o,error:t}=await d.auth.signInWithOAuth({provider:"google",options:{redirectTo:e,queryParams:{access_type:"offline",prompt:"consent"}}});if(t)throw console.error("‚ùå Error en OAuth:",t),t}catch(e){console.error("‚ùå Error completo en OAuth:",e),f(e?.message||"Error con Google OAuth. Verifica que la URL de callback est√© configurada en Supabase.")}}_?.addEventListener("click",I);E?.addEventListener("submit",R);T?.addEventListener("click",F);B?.addEventListener("click",e=>{e.preventDefault(),g("login")});D?.addEventListener("click",e=>{e.preventDefault(),g("register")});P?.addEventListener("click",e=>{e.preventDefault(),g("forgot-password")});O?.addEventListener("click",e=>{e.preventDefault(),g("login")});m?.addEventListener("click",e=>{e.target===m&&I()});window.showLoginModal=()=>g("login");window.showRegisterModal=()=>g("register");window.showForgotPasswordModal=()=>g("forgot-password");window.hideAuthModal=I;N();
