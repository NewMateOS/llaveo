---
import AdminApp from '../../ui/AdminApp.jsx';
import { protectRoute } from '../../lib/auth';

// Asegurar que esta p√°gina se renderice en el servidor (no prerenderizada)
export const prerender = false;

// Verificar si hay un par√°metro de sincronizaci√≥n
const url = new URL(Astro.request.url);
const needsSync = url.searchParams.get('sync') === 'true';

// Si no necesita sincronizaci√≥n, verificar acceso normalmente
if (!needsSync) {
  const { user, hasAccess, error } = await protectRoute(Astro.cookies, 'admin');

  // Logging para debugging
  console.log('üîê [Admin] Verificaci√≥n de acceso:', {
    hasUser: !!user,
    userEmail: user?.email || 'N/A',
    userRole: user?.role || 'N/A',
    hasAccess,
    error: error || 'N/A',
    userId: user?.id || 'N/A'
  });

  if (!hasAccess) {
    // Si no hay acceso pero hay sesi√≥n en el cliente, mostrar p√°gina de sincronizaci√≥n
    // De lo contrario, redirigir a acceso denegado
    // Por ahora, redirigir a acceso denegado
    console.log('‚ùå [Admin] Acceso denegado, redirigiendo a /access-denied');
    return Astro.redirect('/access-denied');
  }
}

const brand = import.meta.env.PUBLIC_BRAND_NAME || 'LLAVE';
---
{needsSync ? (
  // P√°gina intermedia para sincronizar sesi√≥n
  <html lang="es">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Sincronizando sesi√≥n...</title>
    </head>
    <body style="display: flex; align-items: center; justify-content: center; min-height: 100vh; font-family: system-ui;">
      <div style="text-align: center;">
        <p>Sincronizando sesi√≥n...</p>
      </div>
      <script>
        import { getSupabaseClient } from '../../lib/supabase-client';
        
        const supabase = getSupabaseClient();
        
        async function syncAndRedirect() {
          try {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session?.access_token && session?.refresh_token) {
              console.log('üîÑ [Admin] Sincronizando sesi√≥n con servidor...');
              
              const response = await fetch('/api/auth/session', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                  session: {
                    access_token: session.access_token,
                    refresh_token: session.refresh_token,
                  },
                }),
              });
              
              if (response.ok) {
                console.log('‚úÖ [Admin] Sesi√≥n sincronizada, redirigiendo...');
                // Redirigir a /admin sin el par√°metro sync
                window.location.href = '/admin';
              } else {
                console.error('‚ùå [Admin] Error al sincronizar sesi√≥n:', await response.text());
                window.location.href = '/access-denied';
              }
            } else {
              console.log('‚ö†Ô∏è [Admin] No hay sesi√≥n en el cliente');
              window.location.href = '/access-denied';
            }
          } catch (error) {
            console.error('‚ùå [Admin] Error en syncAndRedirect:', error);
            window.location.href = '/access-denied';
          }
        }
        
        syncAndRedirect();
      </script>
    </body>
  </html>
) : (
  // P√°gina normal del admin
  <html lang="es">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Panel de Administraci√≥n ¬∑ {brand}</title>
      <link rel="stylesheet" href="/src/styles/global.css" />
    </head>
    <body class="min-h-screen" style={`background:${import.meta.env.PUBLIC_BRAND_COLOR||'#E2905C'}`}>
      <div id="root"><AdminApp client:load /></div>
      <script>
        // Verificar si hay sesi√≥n en el cliente pero no se sincroniz√≥
        import { getSupabaseClient } from '../../lib/supabase-client';
        
        const supabase = getSupabaseClient();
        
        (async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session) {
            console.log('üîç [Admin] Sesi√≥n encontrada en cliente, verificando sincronizaci√≥n...');
            // Intentar sincronizar en segundo plano
            const response = await fetch('/api/auth/session', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({
                session: {
                  access_token: session.access_token,
                  refresh_token: session.refresh_token,
                },
              }),
            });
            
            if (!response.ok) {
              console.warn('‚ö†Ô∏è [Admin] No se pudo sincronizar sesi√≥n en segundo plano');
            }
          }
        })();
      </script>
    </body>
  </html>
)}
