---
// P√°gina de callback para OAuth
import { supabase } from '../../lib/supabase';

// Headers para prevenir cach√©
Astro.setHeaders({
  'Cache-Control': 'no-store, no-cache, must-revalidate, max-age=0',
  'Pragma': 'no-cache',
  'Expires': '0',
  'X-Content-Type-Options': 'nosniff'
});

// Obtener par√°metros de la URL
const url = new URL(Astro.request.url);
const code = url.searchParams.get('code');
const error = url.searchParams.get('error');
const redirectTo = url.searchParams.get('redirect') || '/';

// Timestamp √∫nico para evitar cach√©
const timestamp = Date.now();

if (error) {
  // Si hay un error, redirigir a la p√°gina principal con mensaje de error
  return Astro.redirect(`/?error=${encodeURIComponent(error)}&_t=${timestamp}`);
}

if (code) {
  console.log('üîÑ [Callback] Intercambiando c√≥digo por sesi√≥n...');
  
  // Intercambiar c√≥digo por sesi√≥n
  const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
  
  if (exchangeError) {
    console.error('‚ùå [Callback] Error exchanging code for session:', exchangeError);
    return Astro.redirect(`/?error=${encodeURIComponent('Error en la autenticaci√≥n')}&_t=${timestamp}`);
  }
  
  if (data.session) {
    console.log('‚úÖ [Callback] Sesi√≥n creada:', data.session.user.email);
    
    // Crear perfil de usuario si no existe
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', data.session.user.id)
      .single();
    
    if (profileError && profileError.code === 'PGRST116') {
      console.log('üìù [Callback] Creando perfil de usuario...');
      // Perfil no existe, crear uno
      const { error: insertError } = await supabase
        .from('profiles')
        .insert({
          id: data.session.user.id,
          full_name: data.session.user.user_metadata?.full_name || data.session.user.email,
          avatar_url: data.session.user.user_metadata?.avatar_url,
          role: 'viewer'
        });
      
      if (insertError) {
        console.error('‚ùå [Callback] Error creating profile:', insertError);
      } else {
        console.log('‚úÖ [Callback] Perfil creado exitosamente');
      }
    } else if (profile) {
      console.log('‚úÖ [Callback] Perfil encontrado:', profile.full_name);
    }
  }
}

// Redirigir a la p√°gina solicitada o a la principal con timestamp para evitar cach√©
console.log('üîÑ [Callback] Redirigiendo a:', redirectTo);
return Astro.redirect(`${redirectTo}?success=login&_t=${timestamp}`);
---

<html>
  <head>
    <title>Procesando autenticaci√≥n...</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div class="min-h-screen flex items-center justify-center bg-gray-50">
      <div class="text-center">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-md" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
          <span class="text-white font-bold text-2xl">L</span>
        </div>
        <h1 class="text-xl font-semibold text-gray-900 mb-2">Procesando autenticaci√≥n...</h1>
        <p class="text-gray-600">Por favor espera mientras completamos tu login.</p>
      </div>
    </div>
  </body>
</html>
